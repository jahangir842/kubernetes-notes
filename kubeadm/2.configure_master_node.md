# Setting Up Kubernetes Control Plane with kubeadm and Containerd

This guide provides a step-by-step procedure to set up a **Kubernetes Control Plane** using `kubeadm` and `containerd`, along with **Calico** as the Container Network Interface (CNI). This is intended for users installing Kubernetes on a master node.

---

## Step 1: Initialize the Kubernetes Control Plane

Run the following command **only on the master node** to initialize the Kubernetes cluster:

```bash
sudo kubeadm init
```

### Optional:
```bash
sudo kubeadm init --pod-network-cidr=192.168.1.0/16
```

### Explanation:
- `kubeadm init`: Initializes the Kubernetes cluster.
- `--pod-network-cidr=192.168.1.0/16`: Specifies the pod network range required for the CNI plugin (Calico in this case).

After the initialization, Kubernetes will provide a `kubeadm join` command. **Save this command** as it will be needed to add worker nodes later.

---

## Step 2: Configure kubectl for the Master Node

To use `kubectl` commands on the master node, set up the configuration:

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

### Explanation:
- The `admin.conf` file contains authentication credentials for accessing the cluster.
- This step ensures the `kubectl` command can communicate with the cluster.

Also, set the `KUBECONFIG` environment variable for persistent access:

```bash
echo "export KUBECONFIG=/etc/kubernetes/admin.conf" >> ~/.bashrc
source ~/.bashrc
```

To verify the configuration:

```bash
echo $KUBECONFIG
```

---

## Step 3: Install Container Networking (Calico)

**Calico** is a highly scalable CNI that provides networking and network policy features for Kubernetes.

### Install Calico:

```bash
sudo dnf install wget -y
wget https://docs.projectcalico.org/manifests/calico.yaml
kubectl apply -f calico.yaml
```

### Explanation:
- **Calico** is installed as a Kubernetes manifest file.
- `kubectl apply -f calico.yaml` deploys the Calico network components.

After installation, verify the networking setup:

```bash
kubectl get pods -n kube-system
```

--- 
## (Optional, If not using Calico)
## Step 3: Install Container Networking (Flannel)**
```bash
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
```

---

## Step 4: Verify the Control Plane Components

Ensure that the Kubernetes control plane components are running:

```bash
kubectl get pods -n kube-system
```

Look for these critical components:
- `kube-apiserver` - Handles API requests.
- `kube-controller-manager` - Maintains cluster state.
- `kube-scheduler` - Assigns workloads to nodes.
- `etcd` - Key-value store for Kubernetes data.

All components should be in the `Running` state.

---

## Step 5: Check Node Status

To verify that the master node is ready, run:

```bash
kubectl get nodes -o wide
```

If the node status shows `NotReady`, wait for a few minutes and recheck.

---

## Step 6: Restart Kubernetes Services (If Necessary)

If any components are not running, restart services:

```bash
sudo systemctl restart kubelet
sudo systemctl restart containerd
```

Additionally, check permissions for `admin.conf` if access issues occur:

```bash
ls -l /etc/kubernetes/admin.conf
sudo chmod 644 /etc/kubernetes/admin.conf
sudo chown $(id -u):$(id -g) /etc/kubernetes/admin.conf
```

---

## Conclusion

You have now successfully set up a **Kubernetes Control Plane** with `kubeadm` and `containerd`, using **Calico** as the CNI. The cluster should be ready for deploying workloads.

To add worker nodes, use the `kubeadm join` command provided during initialization.

### Next Steps:
- Deploy applications using Kubernetes.
- Set up role-based access control (RBAC) for security.
- Configure persistent storage solutions.

For troubleshooting, check logs:

```bash
kubectl logs -n kube-system <pod-name>
```

Happy Kubernetes deployment! ðŸš€

